import asyncio
from pprint import pprint
from time import time
from typing import Dict, Any, Generator, List
from google.protobuf.json_format import MessageToDict
from app.proto.stub import get_new_stub
from app.proto.tangomike_pb2 import TrackPoint, TrackMessage, UploadTrackStreamRequest, TrackRequest


TEST_DATA = {'cid': 1019879,
             'name': 'Jakub K EPKT',
             'callsign': 'RYR3PN',
             'server': 'AMSTERDAM',
             'pilot_rating': None,
             'position': {'lat': 52.23456, 'lng': 9.28039},
             'altitude': 35575,
             'groundspeed': 359,
             'transponder': '2006',
             'heading': 258,
             'qnh_i_hg': 2945,
             'qnh_mb': 997,
             'flight_plan': {'flight_rules': 'I',
                             'aircraft': 'B738/M-VGD/A',
                             'departure': 'EPPO',
                             'arrival': 'EGSS',
                             'alternate': 'EGKK',
                             'deptime': '1753',
                             'enroute_time': '0206',
                             'fuel_time': '0315',
                             'remarks': 'DOF/231030 REG/SPRKX OPR/RYR RMK/VRYR.EU /V/',
                             'route': 'ELSUP Z181 XIGRI DCT GERGA DCT HLZ DCT SAS DCT RKN DCT NIGUG DCT NOGRO M40 RINIS',
                             'cruise_tas': 450,
                             'altitude': 36000},
             'last_updated': 1698691289022,
             'logon_time': 1698688749047,
             'track': [{'lat': 52.5087,
                        'lng': 16.05761,
                        'alt': 17039,
                        'hdg': 270,
                        'gs': 327,
                        'ts': 1698688769022},
                       {'lat': 52.51219,
                        'lng': 15.98235,
                        'alt': 18228,
                        'hdg': 271,
                        'gs': 333,
                        'ts': 1698688799034},
                       {'lat': 52.51407,
                        'lng': 15.94463,
                        'alt': 18840,
                        'hdg': 271,
                        'gs': 334,
                        'ts': 1698688814019},
                       {'lat': 52.51791,
                        'lng': 15.86813,
                        'alt': 19962,
                        'hdg': 271,
                        'gs': 338,
                        'ts': 1698688844009},
                       {'lat': 52.52373,
                        'lng': 15.75158,
                        'alt': 21576,
                        'hdg': 271,
                        'gs': 344,
                        'ts': 1698688889183},
                       {'lat': 52.52757,
                        'lng': 15.67349,
                        'alt': 22585,
                        'hdg': 271,
                        'gs': 347,
                        'ts': 1698688919037},
                       {'lat': 52.53144,
                        'lng': 15.59358,
                        'alt': 23550,
                        'hdg': 271,
                        'gs': 350,
                        'ts': 1698688949042},
                       {'lat': 52.53335,
                        'lng': 15.55375,
                        'alt': 24026,
                        'hdg': 271,
                        'gs': 351,
                        'ts': 1698688964025},
                       {'lat': 52.53947,
                        'lng': 15.39286,
                        'alt': 25772,
                        'hdg': 266,
                        'gs': 354,
                        'ts': 1698689023994},
                       {'lat': 52.53705,
                        'lng': 15.31209,
                        'alt': 26586,
                        'hdg': 263,
                        'gs': 355,
                        'ts': 1698689054023},
                       {'lat': 52.534,
                        'lng': 15.23141,
                        'alt': 27358,
                        'hdg': 263,
                        'gs': 358,
                        'ts': 1698689084031},
                       {'lat': 52.53246,
                        'lng': 15.18973,
                        'alt': 27737,
                        'hdg': 263,
                        'gs': 360,
                        'ts': 1698689099064},
                       {'lat': 52.52834,
                        'lng': 15.07764,
                        'alt': 28724,
                        'hdg': 263,
                        'gs': 363,
                        'ts': 1698689144005},
                       {'lat': 52.52685,
                        'lng': 15.03699,
                        'alt': 29060,
                        'hdg': 263,
                        'gs': 364,
                        'ts': 1698689159014},
                       {'lat': 52.52378,
                        'lng': 14.95378,
                        'alt': 29689,
                        'hdg': 263,
                        'gs': 367,
                        'ts': 1698689189017},
                       {'lat': 52.52221,
                        'lng': 14.91111,
                        'alt': 30007,
                        'hdg': 263,
                        'gs': 368,
                        'ts': 1698689204160},
                       {'lat': 52.51593,
                        'lng': 14.74345,
                        'alt': 31424,
                        'hdg': 263,
                        'gs': 366,
                        'ts': 1698689263990},
                       {'lat': 52.51434,
                        'lng': 14.70179,
                        'alt': 31804,
                        'hdg': 263,
                        'gs': 365,
                        'ts': 1698689279022},
                       {'lat': 52.51317,
                        'lng': 14.66,
                        'alt': 32154,
                        'hdg': 265,
                        'gs': 365,
                        'ts': 1698689294029},
                       {'lat': 52.5231,
                        'lng': 14.53599,
                        'alt': 33163,
                        'hdg': 277,
                        'gs': 371,
                        'ts': 1698689339042},
                       {'lat': 52.53593,
                        'lng': 14.45448,
                        'alt': 33803,
                        'hdg': 278,
                        'gs': 369,
                        'ts': 1698689369066},
                       {'lat': 52.56833,
                        'lng': 14.24889,
                        'alt': 34883,
                        'hdg': 276,
                        'gs': 375,
                        'ts': 1698689443986},
                       {'lat': 52.57477,
                        'lng': 14.20743,
                        'alt': 35167,
                        'hdg': 276,
                        'gs': 375,
                        'ts': 1698689459010},
                       {'lat': 52.58334,
                        'lng': 13.71517,
                        'alt': 35668,
                        'hdg': 259,
                        'gs': 358,
                        'ts': 1698689639038},
                       {'lat': 52.57824,
                        'lng': 13.6338,
                        'alt': 35669,
                        'hdg': 259,
                        'gs': 358,
                        'ts': 1698689669021},
                       {'lat': 52.57047,
                        'lng': 13.51168,
                        'alt': 35669,
                        'hdg': 259,
                        'gs': 358,
                        'ts': 1698689713998},
                       {'lat': 52.5652,
                        'lng': 13.42995,
                        'alt': 35668,
                        'hdg': 259,
                        'gs': 358,
                        'ts': 1698689744013},
                       {'lat': 52.55996,
                        'lng': 13.3496,
                        'alt': 35669,
                        'hdg': 258,
                        'gs': 358,
                        'ts': 1698689774021},
                       {'lat': 52.55721,
                        'lng': 13.30836,
                        'alt': 35669,
                        'hdg': 258,
                        'gs': 358,
                        'ts': 1698689789003},
                       {'lat': 52.55175,
                        'lng': 13.22747,
                        'alt': 35668,
                        'hdg': 258,
                        'gs': 356,
                        'ts': 1698689819028},
                       {'lat': 52.549,
                        'lng': 13.18686,
                        'alt': 35668,
                        'hdg': 258,
                        'gs': 356,
                        'ts': 1698689834033},
                       {'lat': 52.5435,
                        'lng': 13.1058,
                        'alt': 35669,
                        'hdg': 258,
                        'gs': 357,
                        'ts': 1698689864023},
                       {'lat': 52.53798,
                        'lng': 13.02491,
                        'alt': 35669,
                        'hdg': 258,
                        'gs': 357,
                        'ts': 1698689894023},
                       {'lat': 52.53239,
                        'lng': 12.9437,
                        'alt': 35668,
                        'hdg': 258,
                        'gs': 358,
                        'ts': 1698689924019},
                       {'lat': 52.5239,
                        'lng': 12.82182,
                        'alt': 35668,
                        'hdg': 258,
                        'gs': 358,
                        'ts': 1698689968999},
                       {'lat': 52.52105,
                        'lng': 12.78132,
                        'alt': 35669,
                        'hdg': 258,
                        'gs': 358,
                        'ts': 1698689984022},
                       {'lat': 52.51529,
                        'lng': 12.70005,
                        'alt': 35669,
                        'hdg': 258,
                        'gs': 358,
                        'ts': 1698690014017},
                       {'lat': 52.50949,
                        'lng': 12.6189,
                        'alt': 35669,
                        'hdg': 258,
                        'gs': 359,
                        'ts': 1698690044020},
                       {'lat': 52.50359,
                        'lng': 12.5372,
                        'alt': 35668,
                        'hdg': 258,
                        'gs': 359,
                        'ts': 1698690074010},
                       {'lat': 52.49765,
                        'lng': 12.45584,
                        'alt': 35668,
                        'hdg': 257,
                        'gs': 359,
                        'ts': 1698690104002},
                       {'lat': 52.49166,
                        'lng': 12.37447,
                        'alt': 35669,
                        'hdg': 257,
                        'gs': 360,
                        'ts': 1698690134021},
                       {'lat': 52.48864,
                        'lng': 12.3339,
                        'alt': 35669,
                        'hdg': 257,
                        'gs': 360,
                        'ts': 1698690149016},
                       {'lat': 52.48236,
                        'lng': 12.25123,
                        'alt': 35669,
                        'hdg': 257,
                        'gs': 361,
                        'ts': 1698690179022},
                       {'lat': 52.47301,
                        'lng': 12.1289,
                        'alt': 35668,
                        'hdg': 257,
                        'gs': 361,
                        'ts': 1698690224021},
                       {'lat': 52.46671,
                        'lng': 12.04679,
                        'alt': 35669,
                        'hdg': 257,
                        'gs': 361,
                        'ts': 1698690253993},
                       {'lat': 52.46357,
                        'lng': 12.00614,
                        'alt': 35669,
                        'hdg': 257,
                        'gs': 361,
                        'ts': 1698690269069},
                       {'lat': 52.45721,
                        'lng': 11.92416,
                        'alt': 35662,
                        'hdg': 257,
                        'gs': 361,
                        'ts': 1698690299063},
                       {'lat': 52.45082,
                        'lng': 11.84251,
                        'alt': 35653,
                        'hdg': 256,
                        'gs': 360,
                        'ts': 1698690329029},
                       {'lat': 52.44437,
                        'lng': 11.76092,
                        'alt': 35644,
                        'hdg': 256,
                        'gs': 360,
                        'ts': 1698690358989},
                       {'lat': 52.44114,
                        'lng': 11.72039,
                        'alt': 35642,
                        'hdg': 257,
                        'gs': 361,
                        'ts': 1698690374061},
                       {'lat': 52.43461,
                        'lng': 11.63873,
                        'alt': 35641,
                        'hdg': 257,
                        'gs': 359,
                        'ts': 1698690403994},
                       {'lat': 52.42809,
                        'lng': 11.55795,
                        'alt': 35642,
                        'hdg': 257,
                        'gs': 358,
                        'ts': 1698690434023},
                       {'lat': 52.41819,
                        'lng': 11.43676,
                        'alt': 35642,
                        'hdg': 257,
                        'gs': 358,
                        'ts': 1698690479027},
                       {'lat': 52.41148,
                        'lng': 11.35548,
                        'alt': 35642,
                        'hdg': 257,
                        'gs': 358,
                        'ts': 1698690509020},
                       {'lat': 52.40477,
                        'lng': 11.27584,
                        'alt': 35641,
                        'hdg': 256,
                        'gs': 358,
                        'ts': 1698690539014},
                       {'lat': 52.39788,
                        'lng': 11.19474,
                        'alt': 35641,
                        'hdg': 256,
                        'gs': 356,
                        'ts': 1698690569004},
                       {'lat': 52.39104,
                        'lng': 11.11443,
                        'alt': 35641,
                        'hdg': 256,
                        'gs': 356,
                        'ts': 1698690599086},
                       {'lat': 52.38414,
                        'lng': 11.03395,
                        'alt': 35642,
                        'hdg': 256,
                        'gs': 356,
                        'ts': 1698690629025},
                       {'lat': 52.37722,
                        'lng': 10.95361,
                        'alt': 35634,
                        'hdg': 256,
                        'gs': 356,
                        'ts': 1698690659023},
                       {'lat': 52.36677,
                        'lng': 10.83341,
                        'alt': 35620,
                        'hdg': 255,
                        'gs': 354,
                        'ts': 1698690704027},
                       {'lat': 52.35896,
                        'lng': 10.75395,
                        'alt': 35615,
                        'hdg': 253,
                        'gs': 353,
                        'ts': 1698690734023},
                       {'lat': 52.34935,
                        'lng': 10.67503,
                        'alt': 35615,
                        'hdg': 252,
                        'gs': 352,
                        'ts': 1698690764076},
                       {'lat': 52.3445,
                        'lng': 10.63566,
                        'alt': 35615,
                        'hdg': 252,
                        'gs': 352,
                        'ts': 1698690779031},
                       {'lat': 52.33006,
                        'lng': 10.51777,
                        'alt': 35615,
                        'hdg': 253,
                        'gs': 352,
                        'ts': 1698690824021},
                       {'lat': 52.32526,
                        'lng': 10.47861,
                        'alt': 35614,
                        'hdg': 252,
                        'gs': 352,
                        'ts': 1698690839023},
                       {'lat': 52.31564,
                        'lng': 10.40024,
                        'alt': 35615,
                        'hdg': 252,
                        'gs': 352,
                        'ts': 1698690869024},
                       {'lat': 52.29604,
                        'lng': 10.24274,
                        'alt': 35614,
                        'hdg': 252,
                        'gs': 352,
                        'ts': 1698690929040},
                       {'lat': 52.29107,
                        'lng': 10.20318,
                        'alt': 35614,
                        'hdg': 252,
                        'gs': 352,
                        'ts': 1698690944018},
                       {'lat': 52.28124,
                        'lng': 10.12489,
                        'alt': 35614,
                        'hdg': 252,
                        'gs': 352,
                        'ts': 1698690974067},
                       {'lat': 52.27134,
                        'lng': 10.04634,
                        'alt': 35613,
                        'hdg': 252,
                        'gs': 353,
                        'ts': 1698691004030},
                       {'lat': 52.26136,
                        'lng': 9.96745,
                        'alt': 35604,
                        'hdg': 252,
                        'gs': 353,
                        'ts': 1698691034024},
                       {'lat': 52.25235,
                        'lng': 9.8887,
                        'alt': 35594,
                        'hdg': 256,
                        'gs': 356,
                        'ts': 1698691063994},
                       {'lat': 52.24876,
                        'lng': 9.80751,
                        'alt': 35588,
                        'hdg': 259,
                        'gs': 359,
                        'ts': 1698691093998},
                       {'lat': 52.24569,
                        'lng': 9.68515,
                        'alt': 35588,
                        'hdg': 259,
                        'gs': 360,
                        'ts': 1698691139026},
                       {'lat': 52.24252,
                        'lng': 9.56241,
                        'alt': 35588,
                        'hdg': 259,
                        'gs': 360,
                        'ts': 1698691184010},
                       {'lat': 52.23456,
                        'lng': 9.28039,
                        'alt': 35575,
                        'hdg': 258,
                        'gs': 359,
                        'ts': 1698691289022}],
             'aircraft_type': {'aircraft_type': 'AT_LANDPLANE',
                               'description': 'L2J',
                               'engine_count': 2,
                               'engine_type': 'ET_JET',
                               'manufacturer_code': 'BOEING',
                               'name': '737-800',
                               'wtc': 'M',
                               'wtg': 'D'
                               }
             }


def convert(msg: Any) -> Dict[str, Any]:
    return MessageToDict(msg, including_default_value_fields=True, preserving_proto_field_name=True)


def iter_req(points: List[Dict[str, Any]]) -> Generator[UploadTrackStreamRequest, None, None]:
    for i, point in enumerate(points):
        tp = TrackPoint(
            lat=point["lat"],
            lng=point["lng"],
            alt_amsl=float(point["alt"]),
            alt_agl=float(point["alt"]),
            gnd_height=0,
            crs=float(point["hdg"]),
            hdg_true=float(point["hdg"]),
            gs=float(point["gs"]),
            ias=float(point["gs"]),
            tas=float(point["gs"]),
            ap_master=False,
            gear_pct=0,
            flaps=0,
            on_gnd=point["alt"] < 100,
            on_rwy=point["alt"] < 100,
            wind_vel=0.0,
            wind_dir=0.0,
            ts=int(round(time() * 1000))
        )

        yield UploadTrackStreamRequest(
            request_id=i,
            track_message=TrackMessage(
                point=tp
            )
        )


async def get():
    stub = get_new_stub("tmf.vatsimnerd.com:9200")
    resp = await stub.GetTrack(TrackRequest(flight_id="d8e76030-2097-48cd-bce0-ab7eac8f7f51"))
    pprint(convert(resp))


async def upload():
    stub = get_new_stub("tmf.vatsimnerd.com:9200")
    metadata = [
        ("x-flight-id", "d8e76030-2097-48cd-bce0-ab7eac8f7f51"),
        ("x-atc-id", TEST_DATA["callsign"]),
        ("x-auth-token", "9ff8fe11-3bfb-4212-aef4-ca39ac3d5f84")
    ]

    stream = stub.UploadTrackStream(metadata=metadata)

    ack = await stream.read()
    print(convert(ack))

    for req in iter_req(TEST_DATA["track"]):
        await asyncio.sleep(1)

        print(convert(req))
        await stream.write(req)

        ack = await stream.read()
        print(convert(ack))


if __name__ == "__main__":
    asyncio.run(get())
